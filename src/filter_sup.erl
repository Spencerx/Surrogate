%%% -------------------------------------------------------------------
%%% Author  : skruger
%%% Description :
%%%
%%% Created : Nov 11, 2010
%%% -------------------------------------------------------------------
-module(filter_sup).

-behaviour(supervisor).
%% --------------------------------------------------------------------
%% Include files
%% --------------------------------------------------------------------

%% --------------------------------------------------------------------
%% External exports
%% --------------------------------------------------------------------
-export([]).

%% --------------------------------------------------------------------
%% Internal exports
%% --------------------------------------------------------------------
-export([
	 init/1,
	 start_link/0
        ]).

%% --------------------------------------------------------------------
%% Macros
%% --------------------------------------------------------------------
-define(SERVER, ?MODULE).

%% --------------------------------------------------------------------
%% Records
%% --------------------------------------------------------------------

%% ====================================================================
%% External functions
%% ====================================================================

start_link() ->
	io:format("Starting ~p~n",[?MODULE]),
	supervisor:start_link({local,?MODULE},?MODULE,[]).


%% ====================================================================
%% Server functions
%% ====================================================================
%% --------------------------------------------------------------------
%% Func: init/1
%% Returns: {ok,  {SupFlags,  [ChildSpec]}} |
%%          ignore                          |
%%          {error, Reason}
%% --------------------------------------------------------------------
init(_) ->
%% 	io:format("~p:init()~n",[?MODULE]),
	Children = filter_childspecs(proxy_filters),
	io:format("~p children:~n~p~n",[?MODULE,Children]),
    {ok,{{one_for_all,5,1}, Children}}.



%% ====================================================================
%% Internal functions
%% ====================================================================

filter_childspecs(ConfName) ->
	Conf = proxyconf:get(ConfName,[]),
	filter_childspec_list(Conf,[]).

filter_childspec_list([],Acc) ->
	Acc;
filter_childspec_list([CName|R],Acc) ->
	Spec = {CName,
			{CName,filter_start,[]},
			permanent,
			10000,
			worker,
			[]},
	filter_childspec_list(R,[Spec|Acc]).

